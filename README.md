# Readme

## 起動方法

1. git clone
2. npm install
3. sequelize db:migrate
4. npm start
5. localhost:3000にアクセス

****

## 実装したがよく理解していない点

**非同期処理について（promise・async awaitなど）**

**エラーハンドリングについて**

**/bin/www内の記述・listenやcreateServerの仕組み**

****

以下、実装内容です。

## 実装内容

/　ログインの後の画面

/about　（ログイン後の遷移先確認用）

/users/login　ログイン画面

/users/signup　アカウント作成画面

### 基本課題：「ログイン認証システム」の作成

使用技術：Express4.16.1, express-session, sequelize4.44.3, db:sqlite3

以下のパスからアカウント作成・ログインができます。

*/user/signup*　　*/user/login*　(ロジックは*/routes/users.js*に記述）

簡易的ですがバリデーションも実装しました。

### 応用課題1

**1-1 アカウント情報を盗まれた際の被害を軽減**

ライブラリbcryptを使用して、パスワードをハッシュ化して保存するようにしました。bcyptのcompareメソッドで検証しています。

**1-2 悪意のある別サイトからのPOSTを防ぐ**

ライブラリcsurfを使用してCSRF脆弱性の対策をしました。

クッキー(_csrf)とフォームのhidden属性にトークンを入れて検証しています。

**1-3 node.jsアプリケーションを再起動してもログイン状態が持続する**

セッションをサーバーのインメモリではなく、ファイルストアに保存するようにしました。session-file-storeというライブラリを使いました。

/sessionsディレクトリに保存されます。

**1-4 ログインしていない状態でログイン後の画面のURLを入力した場合ログイン画面を表示、ログイン成功後、入力したURLの画面を表示**

*ログインしていない時*：リクエストのあったURLをクッキー(ref)に保存してからログイン画面にリダイレクトします。

*ログイン成功後*：クッキー(ref)が存在すれば、そのURLにリダイレクト、クッキーがなければルートにリダイレクトします。ログイン成功時にはクッキー(ref)を削除します。

この機能は、*/src/require-login.js* 内に書いてあり、ミドルウェアとしてindexルーター内に組み込んであります。

この機能の確認用に　/about　ページを用意しました。

### 応用課題2

**基本機能 ログイン後の画面をログインしたメンバー間でリアルタイムチャットができる画面にする**

socket.ioを使用しました。

クライアント側の処理は*/public/javascripts/io-client.js*

サーバー側の処理は*/src/io-server.js*

に書いてあります。

**追加機能2-1 限られたメンバー間でのみチャットができる**

socket.ioのroomを使用して、ルームを作成できるようにしました。

招待機能・ルームメンバー一覧を実装しました。

ルームを移動するごとに表示されるログが切り替わり、そのルームのログしか表示されないようになっています。

**追加機能2-2 時間経過でセッションが切れた時に再ログインするまでチャットができないようにする**

挑戦しましたが、websocketの初回接続時にしかクッキーを受け取れない状態です。（不完全です）

実現できた内容として、一定時間操作しないとsocket.ioの接続が一度切れますが、自動で再接続する際にセッションが切れていればログイン画面にリダイレクトします。

**追加機能2-3 ネットワークに繋がっていない状態でチャット画面にメッセージを入力した時に対応する**

socket.io-clientの標準機能でオフライン時にポストした内容をオンラインになった時にまとめて送信します。

（Chromeデベロッパーツールで確認）