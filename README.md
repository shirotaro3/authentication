# Readme

## 起動方法

1. git clone
2. npm install
3. sequelize db:migrate
4. npm start
5. localhost:3000にアクセス

****

## 実装したがよく理解していない点

**.thenや.catch、promise、async awaitなど非同期処理について**

処理の実行順や引数などについて細かい部分まで理解できていません。

**エラーハンドリング**

どのような場面でエラーを発生させたらいいのかよく理解できていません。

**ロジックの分割について**

今回、MVCのCにあたる部分を全てルーターに書いてしまったため、ややコードが見づらくなっています。

どこに記述するのがベストなのか色々なサイトを参照しましたが、答えが出ませんでした。

**socket.ioについて**

導入にあたってサーバーにattachしているようですが、何をしているのか仕組みは理解できていません。

emitとonでのやり取りやDOM操作の記述についてはリファレンス等を参考に自分で考えて書きました。

****

以下に実装内容をまとめました。もしお時間があればご覧になってください。

## 実装内容

### 基本課題：「ログイン認証システム」の作成

使用技術：Express4.16.1, express-session, sequelize4.44.3, db:sqlite3

以下のパスからアカウント作成・ログインができます。

*/user/signup*　　*/user/login*　(ロジックは*/routes/users.js*に記述）

バリデーションも実装しました。

### 応用課題1

**1-1 アカウント情報を盗まれた際の被害を軽減**

ライブラリbcryptを使用して、パスワードをハッシュ化して保存するようにしました。bcyptのcompareメソッドで検証しています。

検証の関数をUserクラスのインスタンスメソッドにしました。

**1-2 悪意のある別サイトからのPOSTを防ぐ**

ライブラリcsurfを使用してCSRF脆弱性の対策をしました。

クッキー(_csrf)とフォームのhidden属性にトークンを入れて検証しています。

**1-3 node.jsアプリケーションを再起動してもログイン状態が持続する**

セッションをサーバーのインメモリではなく、ファイルストアに保存するようにしました。session-file-storeというライブラリを使いました。

/sessionsディレクトリに保存されます。

（本番ではAWS Redis等を使ったほうがいいことが分かりました。）

**1-4 ログイン後の画面のURLを入力した際の挙動**

*ログインしていない時*：リクエストのあったパスをクッキー(ref)に保存してからログイン画面にリダイレクトします。

*ログイン成功後*：クッキー(ref)が存在すれば、そのパスにリダイレクト、なければルートにリダイレクトします。その時、クッキー(ref)を削除します。

この機能は、*/middlewares/require-login.js* 内に記述し、ミドルウェアとしてindexルーター内に組み込みました。

### 応用課題2

**基本機能 ログイン後の画面をログインしたメンバー間でリアルタイムチャットができる画面にする**

socket.ioを使用しました。クライアント側の処理は*/public/javascripts/iochat.js*に記述してあります。

ioでもExpressのセッションを利用したかったため、express-socket.io-sessionというライブラリを使用しました。